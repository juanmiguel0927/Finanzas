<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas - Juan Miguel Rios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#151f32', 950: '#020617' }, indigo: { 650: '#4f46e5' } } } }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #loader { position: fixed; inset: 0; background: #0f172a; color: white; display: flex; justify-content: center; align-items: center; z-index: 50; transition: opacity 0.5s; }
        
        /* Inputs */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: currentColor; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 2px; }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #334155; }

        /* Checkbox Custom */
        .checkbox-wrapper input:checked + div { background-color: #4f46e5; border-color: #4f46e5; }
        .checkbox-wrapper input:checked + div svg { display: block; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300 w-full overflow-x-hidden flex justify-center min-h-screen">

    <div id="loader"><h2 class="text-xl font-bold animate-pulse">Cargando Finanzas...</h2></div>

    <div id="app" class="w-full max-w-md bg-white dark:bg-slate-950 shadow-2xl relative border-x border-gray-200 dark:border-slate-800 min-h-screen flex flex-col">
        
        <!-- HEADER -->
        <header class="bg-white/90 dark:bg-slate-900/90 backdrop-blur sticky top-0 z-30 border-b border-gray-200 dark:border-slate-800 px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-sm">F</div>
                <h1 class="font-bold text-gray-800 dark:text-white text-sm">Finanzas</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 text-gray-600 dark:text-slate-400" id="btn-theme">â˜€ï¸</button>
                <button onclick="openConfig()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 text-gray-600 dark:text-slate-400">âš™ï¸</button>
            </div>
        </header>

        <!-- MAIN -->
        <main class="flex-1 px-4 mt-6 flex flex-col gap-5 pb-20">
            
            <!-- Selector Mes -->
            <div class="flex justify-between items-center bg-white dark:bg-slate-900 p-2 rounded-xl shadow-sm border border-gray-200 dark:border-slate-800">
                <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg text-gray-500 font-bold">&lt;</button>
                <div class="flex flex-col items-center">
                    <span id="current-month-display" class="font-bold text-gray-800 dark:text-white capitalize">Cargando...</span>
                    <button onclick="goToCurrentMonth()" class="text-[10px] font-bold text-indigo-500 hover:text-indigo-600 mt-1 uppercase tracking-wide">Hoy</button>
                </div>
                <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg text-gray-500 font-bold">&gt;</button>
            </div>

            <!-- Balance Card -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-6 text-white shadow-xl">
                <div class="mb-4 text-center">
                    <p class="text-indigo-100 text-[10px] uppercase font-bold tracking-wider mb-1">Disponible Real (Mes)</p>
                    <h2 id="balance-main" class="text-5xl font-mono font-bold tracking-tight">$ 0</h2>
                </div>
                <div class="grid grid-cols-3 gap-2 border-t border-white/20 pt-4 text-center">
                    <div><p class="text-[10px] opacity-70">Base</p><p id="income-base" class="font-mono text-xs">$ 0</p></div>
                    <div class="border-x border-white/20"><p class="text-[10px] opacity-70">Extra</p><p id="income-extra" class="font-mono text-xs text-emerald-300">+ $ 0</p></div>
                    <div><p class="text-[10px] opacity-70">Gastado</p><p id="total-spent" class="font-mono text-xs text-rose-300">- $ 0</p></div>
                </div>
            </div>

            <!-- Tarjetas Progreso -->
            <div id="cards-container" class="grid gap-3"></div>

            <!-- GrÃ¡fico CSS -->
            <div class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 p-4 rounded-xl shadow-sm flex flex-col items-center">
                <h4 class="text-xs font-bold text-gray-500 uppercase mb-4">DistribuciÃ³n</h4>
                <div id="pie-chart" class="relative w-40 h-40 rounded-full shadow-inner transition-all duration-500" style="background: #e2e8f0;">
                    <div class="absolute inset-0 m-auto w-24 h-24 bg-white dark:bg-slate-900 rounded-full flex items-center justify-center shadow-lg">
                        <span class="text-xs font-bold text-gray-400">Gastos</span>
                    </div>
                </div>
                <div id="chart-legend" class="flex gap-4 mt-4 text-[10px] text-gray-500 dark:text-slate-400 font-medium"></div>
            </div>

            <!-- BotÃ³n PDF -->
            <button onclick="generatePDF()" class="w-full py-3 bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 text-indigo-600 dark:text-indigo-400 font-bold rounded-xl shadow-sm text-xs hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors">
                ğŸ“„ Descargar Extracto PDF
            </button>

            <!-- Formulario Agregar -->
            <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-gray-200 dark:border-slate-800 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700 dark:text-white text-sm">Nuevo Movimiento</h3>
                    <button onclick="toggleConcepts()" class="text-xs text-indigo-600 font-bold flex items-center gap-1">ğŸ“‹ Conceptos</button>
                </div>
                <div class="flex flex-col gap-3">
                    <div class="flex gap-2">
                        <input id="trans-name" list="concepts-datalist" type="text" placeholder="Concepto (ej. Arriendo)" class="flex-1 bg-gray-100 dark:bg-slate-800 border-none rounded-lg px-3 py-2 text-sm outline-none dark:text-white transition-colors">
                        <datalist id="concepts-datalist"></datalist>
                        <select id="trans-cat" class="bg-gray-100 dark:bg-slate-800 border-none rounded-lg px-2 text-xs outline-none dark:text-white transition-colors">
                            <option value="needs">Fijos</option>
                            <option value="wants">Gustos</option>
                            <option value="savings">Ahorro</option>
                            <option value="extra">Extra (+)</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center gap-2 h-10">
                         <input id="trans-amount" type="text" inputmode="numeric" class="flex-1 h-full bg-gray-100 dark:bg-slate-800 border-none rounded-lg px-3 text-sm font-mono outline-none dark:text-white transition-colors" placeholder="$ 0" oninput="formatInput(this)">
                         
                         <!-- OpciÃ³n Impuesto Personalizable -->
                         <label class="checkbox-wrapper flex items-center gap-2 cursor-pointer bg-gray-50 dark:bg-slate-800 px-3 h-full rounded-lg border border-gray-100 dark:border-slate-700 select-none">
                             <input type="checkbox" id="trans-tax" class="hidden">
                             <div class="w-4 h-4 border-2 border-gray-400 rounded flex items-center justify-center transition-colors">
                                 <svg class="w-3 h-3 text-white hidden pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                             </div>
                             <span id="tax-label" class="text-[10px] font-bold text-gray-500 dark:text-gray-400 whitespace-nowrap">4x1000</span>
                         </label>

                        <button onclick="addTransaction()" class="bg-indigo-600 text-white h-full px-4 rounded-lg font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition-transform flex items-center justify-center text-xl">+</button>
                    </div>
                </div>
            </div>

            <!-- Historial -->
            <div class="bg-white dark:bg-slate-900 rounded-2xl border border-gray-200 dark:border-slate-800 shadow-lg overflow-hidden">
                <div class="p-4 border-b border-gray-200 dark:border-slate-800 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-xs text-gray-500 dark:text-slate-400">Historial del Mes</span>
                        <div class="text-right">
                             <span id="history-total-display" class="font-mono text-xs font-bold text-gray-800 dark:text-white block"></span>
                             <span id="tax-total-display" class="font-mono text-[9px] font-bold text-gray-400 block mt-0.5"></span>
                        </div>
                    </div>
                    <div id="filters-container" class="flex gap-2 overflow-x-auto no-scrollbar pb-1"></div>
                </div>
                <div id="history-list" class="max-h-80 overflow-y-auto custom-scrollbar"></div>
            </div>
        </main>

        <footer class="text-center py-8 mt-auto border-t border-gray-200 dark:border-slate-800/50 bg-gray-50 dark:bg-slate-950">
            <p class="text-[10px] text-gray-500 dark:text-slate-500 font-medium">Desarrollado por <span class="text-indigo-600 dark:text-indigo-400 font-bold">Juan Miguel Rios Redondo</span></p>
        </footer>

        <!-- MODAL CONFIGURACION -->
        <div id="modal-config" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-5 border border-gray-200 dark:border-slate-800 flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800 dark:text-white">ConfiguraciÃ³n</h2>
                        <p id="config-month-label" class="text-[10px] font-bold text-indigo-500 uppercase mt-0.5">---</p>
                    </div>
                    <button onclick="closeConfig()" class="text-gray-400 text-xl">âœ•</button>
                </div>
                
                <div class="overflow-y-auto custom-scrollbar flex-1 space-y-5 px-1">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Ingreso Mensual (Este Mes)</label>
                        <input id="conf-income" type="text" inputmode="numeric" class="w-full bg-gray-100 dark:bg-slate-800 rounded-lg p-3 text-lg font-bold outline-none dark:text-white mt-1" placeholder="0" oninput="handleConfigIncome(this)">
                    </div>

                    <!-- ConfiguraciÃ³n Impuesto -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-gray-200 dark:border-slate-700">
                         <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Tasa Impuesto (x1000)</label>
                         <div class="flex items-center gap-2">
                             <input id="conf-tax-rate" type="number" class="w-16 bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-600 rounded px-2 py-1 text-center text-sm outline-none dark:text-white font-mono" value="4" oninput="if(this.value<0)this.value=0">
                             <span class="text-xs text-gray-400">Ej: 4 para 4x1000</span>
                         </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between text-xs font-bold text-gray-500 border-b border-gray-200 dark:border-slate-700 pb-1">
                            <span id="dist-total-lbl">DistribuciÃ³n</span>
                            <button onclick="applyDefaultDist()" class="text-indigo-600 hover:underline">Restablecer 50/30/20</button>
                        </div>
                        <div id="config-rows"></div>
                    </div>
                </div>

                <div class="shrink-0 space-y-3 pt-4 border-t border-gray-200 dark:border-slate-800 mt-2">
                    <button onclick="saveConfig()" id="btn-save-config" class="w-full py-3 rounded-xl font-bold text-sm bg-indigo-600 text-white shadow-lg hover:bg-indigo-700 transition-colors">Guardar Cambios</button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="exportData()" class="py-2 bg-gray-100 dark:bg-slate-800 rounded-lg text-xs font-bold text-gray-600 dark:text-slate-300 border border-gray-200 dark:border-slate-700">â¬‡ï¸ Backup</button>
                        <label class="flex justify-center items-center gap-2 py-2 bg-gray-100 dark:bg-slate-800 rounded-lg text-xs font-bold text-gray-600 dark:text-slate-300 border border-gray-200 dark:border-slate-700 cursor-pointer">
                            â¬†ï¸ Restaurar <input type="file" onchange="importData(this)" class="hidden" accept=".json">
                        </label>
                    </div>

                    <!-- BOTONES BORRAR -->
                    <button onclick="clearMonthTransactions()" class="w-full py-2 bg-yellow-50 dark:bg-yellow-900/10 text-yellow-600 dark:text-yellow-400 rounded-lg text-xs font-bold border border-yellow-200 dark:border-yellow-800/30">ğŸ§¹ Limpiar Movimientos (Este Mes)</button>
                    
                    <button onclick="resetMonth()" class="w-full py-2 bg-orange-50 dark:bg-orange-900/10 text-orange-600 dark:text-orange-400 rounded-lg text-xs font-bold border border-orange-200 dark:border-orange-800/30">ğŸ—‘ï¸ Reiniciar Mes (Config + Datos)</button>
                    
                    <button onclick="resetAll()" class="w-full text-xs text-rose-500 hover:underline text-center py-2">ğŸ”¥ Reiniciar de FÃ¡brica</button>
                </div>
            </div>
        </div>

        <!-- MODAL CONCEPTOS -->
        <div id="modal-concepts" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-5 border border-gray-200 dark:border-slate-800">
                <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-800 dark:text-white">Conceptos</h3><button onclick="closeConcepts()" class="text-gray-400">âœ•</button></div>
                <div class="flex gap-2 mb-4"><input id="new-concept-input" class="flex-1 bg-gray-100 dark:bg-slate-800 rounded px-3 py-2 text-sm outline-none dark:text-white" placeholder="Nuevo..."><button onclick="addConcept()" class="bg-indigo-600 text-white rounded px-3 font-bold">+</button></div>
                <div id="concepts-list-ui" class="max-h-60 overflow-y-auto custom-scrollbar flex flex-col gap-2"></div>
            </div>
        </div>
    </div>

    <!-- LOGICA JS -->
    <script>
        // --- LLAVE MAESTRA ---
        const DB_KEY = 'finanzas_v78_custom_tax';
        
        // --- LLAVES ANTERIORES PARA MIGRAR DATOS ---
        const OLD_KEYS = [
            'finanzas_app_production',
            'finanzas_v75_final_perfect', 
            'finanzas_v73_precision_fix', 
            'finanzas_v66_clean_monthly', 
            'finanzas_v54_data'
        ];

        // DATOS INICIALES
        const INITIAL_DATA = {
            monthlyBudgets: {},
            defaultConfig: { income: 0, mNeeds: 0, mWants: 0, mSavings: 0, pNeeds: 50, pWants: 30, pSavings: 20 },
            transactions: [],
            concepts: [],
            isDark: false,
            taxRate: 4 // Tasa por defecto: 4x1000
        };

        const CATEGORY_ICONS = { needs: 'ğŸ ', wants: 'ğŸ‰', savings: 'ğŸ·', extra: 'ğŸ’' };
        
        let state = INITIAL_DATA;
        let currentDate = new Date();
        let currentFilter = 'all';

        const THEME = {
            needs: { label: 'Fijos', color: 'bg-blue-500', text: 'text-blue-500' },
            wants: { label: 'Gustos', color: 'bg-pink-500', text: 'text-pink-500' },
            savings: { label: 'Ahorro', color: 'bg-emerald-500', text: 'text-emerald-500' },
            extra: { label: 'Extra', color: 'bg-purple-500', text: 'text-purple-500' }
        };

        function formatCOP(num) { return new Intl.NumberFormat('es-CO').format(num); }
        function parseClean(str) { return parseFloat(String(str).replace(/\./g, '').replace(/,/g, '.')) || 0; }
        function formatInput(el) { let val = el.value.replace(/\D/g, ''); el.value = val !== '' ? new Intl.NumberFormat('es-CO').format(parseInt(val)) : ''; }
        function getMonthKey(d) { return `${d.getFullYear()}-${d.getMonth()}`; }

        function getMonthlyBudget(date) {
            const key = getMonthKey(date);
            if (state.monthlyBudgets && state.monthlyBudgets[key]) {
                return state.monthlyBudgets[key];
            }
            return { income: 0, mNeeds: 0, mWants: 0, mSavings: 0, pNeeds: 50, pWants: 30, pSavings: 20 };
        }

        // --- SISTEMA DE CARGA Y MIGRACIÃ“N ---
        function loadData() {
            // 1. Intentar cargar la base de datos actual
            const masterData = localStorage.getItem(DB_KEY);
            if (masterData) return JSON.parse(masterData);

            // 2. Si no existe, buscar datos antiguos y migrarlos
            for (let oldKey of OLD_KEYS) {
                const oldData = localStorage.getItem(oldKey);
                if (oldData) {
                    console.log("Migrando datos de: " + oldKey);
                    const parsed = JSON.parse(oldData);
                    // Asegurar compatibilidad
                    if(!parsed.monthlyBudgets) parsed.monthlyBudgets = {};
                    return { ...INITIAL_DATA, ...parsed };
                }
            }
            return INITIAL_DATA;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').remove(), 500);
            
            // Cargar datos (o migrar)
            state = loadData();
            // Asegurar que taxRate exista en datos migrados
            if (state.taxRate === undefined) state.taxRate = 4;
            
            saveState();
            
            if (state.isDark) document.documentElement.classList.add('dark');
            document.getElementById('btn-theme').innerText = state.isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            
            // Actualizar etiqueta del impuesto en UI
            updateTaxLabel();

            renderConfigRows();
            renderFilters();
            
            const budget = getMonthlyBudget(currentDate);
            if (budget.income === 0 && state.transactions.length === 0) openConfig();
            
            render();
        });

        function saveState() { localStorage.setItem(DB_KEY, JSON.stringify(state)); render(); }
        function goToCurrentMonth() { currentDate = new Date(); render(); }
        
        function updateTaxLabel() {
             const label = document.getElementById('tax-label');
             if(label) label.innerText = `${state.taxRate}x1000`;
        }

        function render() {
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            document.getElementById('current-month-display').innerText = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            const budget = getMonthlyBudget(currentDate);

            const monthTrans = state.transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
            }).sort((a,b) => b.id - a.id);

            let spent = { needs: 0, wants: 0, savings: 0, extra: 0 };
            let totalSpent = 0, totalExtra = 0;
            let totalTax = 0;

            monthTrans.forEach(t => {
                if (t.tax) totalTax += t.tax;
                
                if(t.category === 'extra') totalExtra += t.amount;
                else {
                    spent[t.category] = (spent[t.category] || 0) + t.amount;
                    totalSpent += t.amount;
                }
            });

            const balance = (budget.income + totalExtra) - totalSpent;
            const limits = { needs: budget.mNeeds, wants: budget.mWants, savings: budget.mSavings };

            document.getElementById('balance-main').innerText = `$ ${formatCOP(balance)}`;
            document.getElementById('income-base').innerText = `$ ${formatCOP(budget.income)}`;
            document.getElementById('income-extra').innerText = `+ $ ${formatCOP(totalExtra)}`;
            document.getElementById('total-spent').innerText = `- $ ${formatCOP(totalSpent)}`;
            document.getElementById('tax-total-display').innerText = totalTax > 0 ? `Impuestos (${state.taxRate}x1000): $ ${formatCOP(totalTax)}` : '';

            const cardsCont = document.getElementById('cards-container');
            cardsCont.innerHTML = '';
            
            ['needs', 'wants', 'savings'].forEach(k => {
                const limit = limits[k] || 1;
                const s = spent[k];
                const pct = limit > 0 ? Math.min((s/limit)*100, 100) : 0;
                const rem = limit - s;
                const isOver = rem < 0;
                const t = THEME[k];
                
                const pKey = 'p' + k.charAt(0).toUpperCase() + k.slice(1);
                const pctStored = budget[pKey] || 0;

                cardsCont.innerHTML += `
                <div class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 rounded-xl p-3 shadow-sm fade-in">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-1.5">
                            <span class="text-lg">${CATEGORY_ICONS[k]}</span>
                            <div><h3 class="font-bold text-xs uppercase ${t.text}">${t.label}</h3><span class="text-[10px] text-gray-400">Asig: ${pctStored}%</span></div>
                        </div>
                        <div class="text-right"><p class="text-[9px] uppercase text-gray-400 font-bold">Tope</p><p class="text-xs font-mono font-bold dark:text-white">$ ${formatCOP(limit)}</p></div>
                    </div>
                    <div class="h-1.5 w-full bg-gray-200 dark:bg-slate-800 rounded-full overflow-hidden mb-1">
                        <div class="h-full transition-all duration-500 ${isOver ? 'bg-red-500' : t.color}" style="width: ${isOver ? 100 : pct}%"></div>
                    </div>
                    <div class="flex justify-between text-xs items-center"><span class="font-mono font-bold ${t.text}">$ ${formatCOP(s)}</span><span class="font-mono font-bold ${isOver ? 'text-red-500' : 'text-gray-500 dark:text-slate-400'}">${isOver ? 'Exceso: ' : 'Disp: '}$ ${formatCOP(Math.abs(rem))}</span></div>
                </div>`;
            });

            const totalPie = totalSpent || 1;
            const pN = (spent.needs / totalPie) * 100;
            const pW = (spent.wants / totalPie) * 100;
            const pS = (spent.savings / totalPie) * 100;
            const grad = totalSpent > 0 ? `conic-gradient(#3b82f6 0% ${pN}%, #ec4899 ${pN}% ${pN+pW}%, #10b981 ${pN+pW}% 100%)` : '#e2e8f0';
            document.getElementById('pie-chart').style.background = grad;

            document.getElementById('chart-legend').innerHTML = `
                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-500"></div>Fijos ${pN.toFixed(0)}%</div>
                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-pink-500"></div>Gustos ${pW.toFixed(0)}%</div>
                <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500"></div>Ahorro ${pS.toFixed(0)}%</div>
            `;

            renderHistory(monthTrans);

            const dl = document.getElementById('concepts-datalist');
            dl.innerHTML = state.concepts.map(c => `<option value="${c}">`).join('');
            
            const clList = document.getElementById('concepts-list-ui');
            clList.innerHTML = state.concepts.map((c, i) => `
                <div class="flex justify-between items-center bg-gray-50 dark:bg-slate-800 px-3 py-2 rounded-lg border border-gray-100 dark:border-slate-700">
                    <span class="text-sm dark:text-white">${c}</span>
                    <button onclick="removeConcept(${i})" class="text-gray-400 hover:text-red-500">âœ•</button>
                </div>
            `).join('');

            document.querySelectorAll('#filters-container button').forEach(btn => {
                if(btn.dataset.cat === currentFilter) {
                    btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                    btn.classList.remove('bg-white', 'dark:bg-slate-900', 'text-gray-500', 'dark:text-slate-400');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                    btn.classList.add('bg-white', 'dark:bg-slate-900', 'text-gray-500', 'dark:text-slate-400');
                }
            });
            
            // Actualizar etiqueta del impuesto en UI principal si es necesario (se hace en init y config)
            updateTaxLabel();
        }

        function renderFilters() {
            const cont = document.getElementById('filters-container');
            const cats = ['all', 'needs', 'wants', 'savings', 'extra'];
            const labels = {all:'Todo', needs:'Fijos', wants:'Gustos', savings:'Ahorro', extra:'Extra'};
            cont.innerHTML = cats.map(c => `
                <button onclick="setFilter('${c}')" data-cat="${c}" class="px-3 py-1 rounded-full text-[10px] font-bold whitespace-nowrap border transition-colors bg-white dark:bg-slate-900 text-gray-500 dark:text-slate-400 border-gray-200 dark:border-slate-700">${labels[c]}</button>
            `).join('');
        }

        function setFilter(c) { currentFilter = c; render(); }

        function renderHistory(list) {
            const cont = document.getElementById('history-list');
            const subtotalEl = document.getElementById('history-total-display');
            let filtered = currentFilter === 'all' ? list : list.filter(t => t.category === currentFilter);
            
            let subtotal = 0;
            filtered.forEach(t => { if(t.category === 'extra') subtotal += t.amount; else subtotal += t.amount; }); 
            
            let subtotalText = "";
            if (['needs', 'wants', 'savings'].includes(currentFilter)) {
                 const sum = filtered.reduce((a,b) => a + b.amount, 0);
                 subtotalText = `Total: $ ${formatCOP(sum)}`;
            } else if (currentFilter === 'extra') {
                 const sum = filtered.reduce((a,b) => a + b.amount, 0);
                 subtotalText = `Total: +$ ${formatCOP(sum)}`;
            } else {
                 subtotalText = `Neto: $ ${formatCOP(subtotal)}`;
            }
            subtotalEl.innerText = subtotalText;

            if(filtered.length === 0) { cont.innerHTML = '<div class="p-8 text-center text-gray-400 text-xs">Sin registros.</div>'; return; }

            cont.innerHTML = filtered.map(t => `
                <div class="flex justify-between items-center p-3 border-b border-gray-100 dark:border-slate-800 fade-in">
                    <div class="flex items-center gap-3">
                        <div class="text-lg">${getIcon(t.name, t.category)}</div>
                        <div>
                            <p class="text-xs font-bold text-gray-800 dark:text-white">${t.name}</p>
                            <p class="text-[9px] text-gray-400">
                                ${new Date(t.date).getDate()}/${new Date(t.date).getMonth()+1}
                                ${t.tax ? `<span class="text-indigo-500 font-bold ml-1">(+${state.taxRate || 4}x1000)</span>` : ''}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-mono text-xs font-bold ${t.category==='extra'?'text-purple-500':'text-gray-600 dark:text-slate-300'}">
                            ${t.category==='extra'?'':'-'} ${formatCOP(t.amount)}
                        </span>
                        <button onclick="deleteTrans(${t.id})" class="text-gray-300 hover:text-red-500 text-sm">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function renderConfigRows() {
            const container = document.getElementById('config-rows');
            const items = [{k:'Needs', l:'Fijos'}, {k:'Wants', l:'Gustos'}, {k:'Savings', l:'Ahorro'}];
            container.innerHTML = items.map(i => `
                <div class="space-y-1">
                    <div class="flex justify-between items-end"><span class="text-xs font-bold text-gray-700 dark:text-slate-200">${i.l}</span><button onclick="autoFill('p${i.k}')" class="text-[10px] text-gray-500 bg-gray-100 dark:bg-slate-800 px-2 py-0.5 rounded border border-gray-200 dark:border-slate-700">âš¡ Auto</button></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="relative"><input id="conf-p${i.k}" type="number" class="w-full bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded px-2 py-2 text-right text-sm outline-none dark:text-white" oninput="updateFromPercent('${i.k}')" placeholder="0"><span class="absolute right-7 top-2 text-xs text-gray-400 pointer-events-none">%</span></div>
                        <div class="relative"><span class="absolute left-2 top-2 text-xs text-gray-400 pointer-events-none">$</span><input id="conf-m${i.k}" type="text" inputmode="numeric" class="w-full bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded px-2 py-2 pl-5 text-right text-sm outline-none dark:text-white font-mono" oninput="updateFromMoney('${i.k}', this)" placeholder="0"></div>
                    </div>
                </div>
            `).join('');
        }

        function handleConfigIncome(el) {
            formatInput(el);
            const inc = parseClean(el.value);
            ['Needs', 'Wants', 'Savings'].forEach(k => {
                const p = parseFloat(document.getElementById(`conf-p${k}`).value) || 0;
                const m = (inc * (p / 100)).toFixed(0);
                document.getElementById(`conf-m${k}`).value = formatCOP(m);
            });
            updateTotalP();
        }

        function updateFromPercent(key) {
            const inc = parseClean(document.getElementById('conf-income').value);
            const p = parseFloat(document.getElementById(`conf-p${key}`).value) || 0;
            const m = (inc * (p / 100)).toFixed(0);
            document.getElementById(`conf-m${key}`).value = formatCOP(m);
            updateTotalP();
        }

        function updateFromMoney(key, el) {
            formatInput(el);
            const m = parseClean(el.value);
            const inc = parseClean(document.getElementById('conf-income').value);
            if (inc > 0) {
                const p = ((m / inc) * 100).toFixed(2);
                document.getElementById(`conf-p${key}`).value = parseFloat(p);
            }
            updateTotalP();
        }

        function applyDefaultDist() {
            const inc = parseClean(document.getElementById('conf-income').value);
            const set = (k, p) => {
                document.getElementById(`conf-p${k}`).value = p;
                document.getElementById(`conf-m${k}`).value = inc > 0 ? formatCOP((inc * (p/100)).toFixed(0)) : 0;
            };
            set('Needs', 50); set('Wants', 30); set('Savings', 20);
            updateTotalP();
        }

        function autoFill(targetP) {
            const keys = ['pNeeds', 'pWants', 'pSavings'];
            let sumOthers = 0;
            keys.forEach(k => {
                if (k !== targetP) {
                    const inputId = `conf-${k}`;
                    const val = parseFloat(document.getElementById(inputId).value) || 0;
                    sumOthers += val;
                }
            });
            const rem = 100 - sumOthers;
            if (rem >= 0) {
                document.getElementById(`conf-${targetP}`).value = parseFloat(rem.toFixed(2));
                updateFromPercent(targetP.substring(1));
            } else {
                alert(`La suma de los otros (${sumOthers}%) ya supera el 100%`);
            }
        }

        function updateTotalP() {
             const sum = ['pNeeds', 'pWants', 'pSavings'].reduce((acc, k) => acc + (parseFloat(document.getElementById(`conf-${k}`).value)||0), 0);
             const lbl = document.getElementById('dist-total-lbl');
             lbl.innerText = `DistribuciÃ³n (${sum.toFixed(1)}%)`;
             lbl.className = Math.abs(sum - 100) < 0.1 ? "text-emerald-500 font-bold flex justify-between border-b pb-1" : "text-rose-500 font-bold flex justify-between border-b pb-1";
        }

        function changeMonth(offset) { currentDate.setMonth(currentDate.getMonth() + offset); render(); }
        function toggleTheme() { state.isDark = !state.isDark; saveState(); if(state.isDark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); document.getElementById('btn-theme').innerText = state.isDark ? 'ğŸŒ™' : 'â˜€ï¸'; }
        
        function openConfig() {
            document.getElementById('modal-config').classList.remove('hidden');
            const budget = getMonthlyBudget(currentDate);
            
            const monthName = document.getElementById('current-month-display').innerText;
            document.getElementById('config-month-label').innerText = `(${monthName})`;

            document.getElementById('conf-income').value = formatCOP(budget.income);
            // Cargar tasa de impuesto
            document.getElementById('conf-tax-rate').value = state.taxRate || 4;

            ['Needs', 'Wants', 'Savings'].forEach(k => {
                const pKey = 'p' + k;
                const mKey = 'm' + k;
                document.getElementById(`conf-p${k}`).value = budget[pKey] || 0;
                document.getElementById(`conf-m${k}`).value = formatCOP(budget[mKey] || 0);
            });
            updateTotalP();
        }
        function closeConfig() { document.getElementById('modal-config').classList.add('hidden'); }
        
        function saveConfig() {
            const inc = parseClean(document.getElementById('conf-income').value);
            if(inc <= 0 && document.getElementById('conf-income').value !== "" && document.getElementById('conf-income').value !== "0") return alert("Ingreso invÃ¡lido");
            
            const key = getMonthKey(currentDate);
            const newBudget = {
                income: inc,
                mNeeds: parseClean(document.getElementById('conf-mNeeds').value),
                mWants: parseClean(document.getElementById('conf-mWants').value),
                mSavings: parseClean(document.getElementById('conf-mSavings').value),
                pNeeds: parseFloat(document.getElementById('conf-pNeeds').value) || 0,
                pWants: parseFloat(document.getElementById('conf-pWants').value) || 0,
                pSavings: parseFloat(document.getElementById('conf-pSavings').value) || 0
            };
            
            if(!state.monthlyBudgets) state.monthlyBudgets = {};
            state.monthlyBudgets[key] = newBudget;
            
            // Guardar Tasa Impuesto
            state.taxRate = parseFloat(document.getElementById('conf-tax-rate').value) || 0;
            updateTaxLabel(); // Actualizar UI principal

            saveState(); 
            closeConfig();
        }
        
        function updateTaxLabel() {
             const label = document.getElementById('tax-label');
             if(label) label.innerText = `${state.taxRate || 4}x1000`;
        }

        // --- BORRAR SOLO MOVIMIENTOS DEL MES ---
        function clearMonthTransactions() {
            const currentKey = getMonthKey(currentDate);
            const monthName = document.getElementById('current-month-display').innerText;

            if(confirm(`Â¿EstÃ¡s seguro de limpiar la LISTA DE GASTOS de ${monthName}? El ingreso base se mantendrÃ¡.`)) {
                state.transactions = state.transactions.filter(t => {
                    const d = new Date(t.date);
                    return getMonthKey(d) !== currentKey;
                });
                saveState();
                render();
            }
        }

        // --- BORRAR MES COMPLETO (Config + Movimientos) ---
        function resetMonth() {
            const currentKey = getMonthKey(currentDate);
            const monthName = document.getElementById('current-month-display').innerText;
            
            if(confirm(`Â¿Borrar TODO (Ingreso + Gastos) de ${monthName}?`)) {
                state.transactions = state.transactions.filter(t => {
                    const d = new Date(t.date);
                    return getMonthKey(d) !== currentKey;
                });

                if(state.monthlyBudgets && state.monthlyBudgets[currentKey]) {
                    delete state.monthlyBudgets[currentKey];
                }

                saveState();
                closeConfig();
                render();
                // Si queda en 0, abrir config para rellenar
                const budget = getMonthlyBudget(currentDate);
                if (budget.income === 0) openConfig(); 
            }
        }

        function addTransaction() {
            const name = document.getElementById('trans-name').value;
            let amt = parseClean(document.getElementById('trans-amount').value);
            const cat = document.getElementById('trans-cat').value;
            const hasTax = document.getElementById('trans-tax').checked;

            if(!name || amt <= 0) return;
            if(!state.concepts.includes(name)) state.concepts.push(name);
            
            let taxValue = 0;
            // Usar la tasa configurada (state.taxRate)
            const rate = (state.taxRate !== undefined ? state.taxRate : 4) / 1000;

            if (cat !== 'extra' && hasTax) {
                taxValue = Math.round(amt * rate);
                amt += taxValue;
            }

            let transDate = new Date();
            if (transDate.getMonth() !== currentDate.getMonth() || transDate.getFullYear() !== currentDate.getFullYear()) {
                transDate = new Date(currentDate); 
            }

            state.transactions.unshift({ 
                id: Date.now(), 
                date: transDate.toISOString(), 
                name, 
                amount: amt, 
                category: cat,
                tax: taxValue 
            });

            document.getElementById('trans-name').value = '';
            document.getElementById('trans-amount').value = '';
            document.getElementById('trans-tax').checked = false;
            saveState();
        }

        function deleteTrans(id) { if(confirm("Â¿Eliminar?")) { state.transactions = state.transactions.filter(t => t.id !== id); saveState(); } }
        function toggleConcepts() { document.getElementById('modal-concepts').classList.remove('hidden'); }
        function closeConcepts() { document.getElementById('modal-concepts').classList.add('hidden'); }
        function addConcept() { const v = document.getElementById('new-concept-input').value; if(v){ state.concepts.push(v); saveState(); document.getElementById('new-concept-input').value=''; render(); } }
        function removeConcept(i) { state.concepts.splice(i, 1); saveState(); }

        function generatePDF() {
            if(!window.jspdf) return alert("PDF cargando...");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const budget = getMonthlyBudget(currentDate);
            
            doc.setFontSize(16); doc.text("Extracto Financiero", 14, 20);
            doc.setFontSize(10); doc.text(`Juan Miguel Rios Redondo - ${new Date().toLocaleDateString()}`, 14, 26);
            
            const rows = state.transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear(); }).map(t => [new Date(t.date).toLocaleDateString(), t.name + (t.tax ? ` (+${state.taxRate||4}x1000)` : ""), t.category, `$ ${formatCOP(t.amount)}`]);
            doc.autoTable({ startY: 35, head: [['Fecha', 'Concepto', 'Tipo', 'Monto']], body: rows });
            const finalY = doc.lastAutoTable.finalY + 10;
            
            let spent = 0; let extra = 0; let totalTax = 0;
            state.transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear(); }).forEach(t => { 
                if(t.category === 'extra') extra += t.amount; 
                else spent += t.amount;
                if(t.tax) totalTax += t.tax;
            });
            const balance = (budget.income + extra) - spent;

            doc.text(`Resumen Mensual:`, 14, finalY + 5);
            doc.text(`Base: $ ${formatCOP(budget.income)}`, 14, finalY + 12);
            doc.text(`Extra: + $ ${formatCOP(extra)}`, 14, finalY + 18);
            doc.text(`Gastado: - $ ${formatCOP(spent)}`, 14, finalY + 24);
            if (totalTax > 0) doc.text(`(Incluye ${state.taxRate||4}x1000: $ ${formatCOP(totalTax)})`, 14, finalY + 30);
            
            doc.setFont(undefined, 'bold');
            doc.text(`Disponible Final: $ ${formatCOP(balance)}`, 14, finalY + 40);

            doc.save('finanzas.pdf');
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const anchor = document.createElement('a'); anchor.href = dataStr; anchor.download = "backup.json"; anchor.click();
        }

        function importData(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { try { state = JSON.parse(e.target.result); saveState(); alert("Importado"); closeConfig(); } catch { alert("Error"); } };
            reader.readAsText(file);
        }

        function resetAll() { if(confirm("Â¿Borrar todo?")) { localStorage.removeItem(DB_KEY); location.reload(); } }
        
        function getIcon(name, cat) {
            // Smart Match
            const lowerName = (name || '').toLowerCase();
            const map = { 'netflix': 'ğŸ¬', 'spotify': 'ğŸµ', 'mercado': 'ğŸ›’', 'comida': 'ğŸ”', 'uber': 'ğŸš•', 'transporte': 'ğŸšŒ', 'gasolina': 'â›½', 'cine': 'ğŸ¿', 'arriendo': 'ğŸ ', 'luz': 'ğŸ’¡', 'agua': 'ğŸ’§', 'internet': 'ğŸŒ', 'celular': 'ğŸ“±', 'gym': 'ğŸ’ª', 'salud': 'ğŸ’Š', 'regalo': 'ğŸ', 'viaje': 'âœˆï¸', 'ropa': 'ğŸ‘•', 'cafe': 'â˜•', 'cerveza': 'ğŸº', 'ahorro': 'ğŸ·', 'banco': 'ğŸ¦', 'nomina': 'ğŸ’°', 'sueldo': 'ğŸ’°', 'ara': 'ğŸ›’', 'isimo': 'ğŸ›’', 'olimpica': 'ğŸ›’', 'exito': 'ğŸ›’', 'd1': 'ğŸ›’' };
            for (const key in map) if (lowerName.includes(key)) return map[key];
            
            // Category Fallback
            return CATEGORY_ICONS[cat] || 'â“';
        }
    </script>
</body>
</html>
